
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Running your own StarDist3D model in napari &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pages/stardist3D-model-napari';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running Cellpose in QuPath" href="qupath-cellpose.html" />
    <link rel="prev" title="Training your StarDist 2D or 3D model on local GPU" href="stardist3Dlocally.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Topic Guides</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stardist3Dlocally.html">Training stardist2D/3D models on local GPU</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Running a trained StarDist3D model in napari</a></li>
<li class="toctree-l1"><a class="reference internal" href="qupath-cellpose.html">Running Cellpose/Omnipose in QuPath</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fpages/stardist3D-model-napari.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/pages/stardist3D-model-napari.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Running your own StarDist3D model in napari</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#requirements">Requirements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-napari-with-stardist-plugin">1 Install napari with StarDist plugin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-stardist-napari-plugin-with-a-pre-trained-model">2 Testing the stardist-napari plugin with a pre-trained model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-stardist-napari-plugin-with-your-own-trained-model">3 Running the stardist-napari plugin with your own trained model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-next">What is next?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concluding-remarks">Concluding Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-cuda">Step 1 CUDA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-cudnn">Step 2 cuDNN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5">Step 5</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pitfalls">Pitfalls</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="running-your-own-stardist3d-model-in-napari">
<h1>Running your own StarDist3D model in napari<a class="headerlink" href="#running-your-own-stardist3d-model-in-napari" title="Link to this heading">#</a></h1>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Link to this heading">#</a></h2>
<p>You should have already performed the following:</p>
<ul class="simple">
<li><p>Installed Miniforge per this post.</p></li>
<li><p>Trained your own StarDist model per this post {in preparation} (optional if you plan to use the pre-trained model).</p></li>
<li><p>Installed Git (download at: <a class="reference external" href="https://git-scm.com/downloads/win">https://git-scm.com/downloads/win</a>)</p></li>
</ul>
</section>
<section id="install-napari-with-stardist-plugin">
<h2>1 Install napari with StarDist plugin<a class="headerlink" href="#install-napari-with-stardist-plugin" title="Link to this heading">#</a></h2>
<p>We will create a new conda environment to run StarDist as a napari plugin.</p>
<p><strong>1.1</strong> Create a custom Conda environment <code class="docutils literal notranslate"><span class="pre">stardist-napari</span></code>
Enter the following command in the Miniforge Prompt and press <kbd class="kbd docutils literal notranslate">Enter</kbd>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mamba<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>stardist-napari<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8<span class="w"> </span>pip<span class="w"> </span><span class="nv">cudatoolkit</span><span class="o">=</span><span class="m">11</span>.2<span class="w"> </span><span class="nv">cudnn</span><span class="o">=</span><span class="m">8</span>.1.0<span class="w"> </span>-y
</pre></div>
</div>
<p>This process may take a few minutes while downloading and extracting the required packages.</p>
<p><strong>1.2</strong> Activate the environment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mamba<span class="w"> </span>activate<span class="w"> </span>stardist-napari
</pre></div>
</div>
<p>The Miniforge Prompt will change from <code class="docutils literal notranslate"><span class="pre">(base)</span> <span class="pre">C:\...&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">(stardist-napari)</span> <span class="pre">C:\...</span></code> or similar</p>
<p><strong>1.3</strong> Install the specified versions of TensorFlow, NumPy and Napari that are compatible for running StarDist with GPU support. In the Miniforge Prompt, enter each command line-by-line and press <code class="docutils literal notranslate"><span class="pre">enter</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">tensorflow</span><span class="o">==</span><span class="m">2</span>.10
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">numpy</span><span class="o">==</span><span class="m">1</span>.23.5
pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;napari[all]==0.4.18&quot;</span>
</pre></div>
</div>
<p><strong>1.4</strong> Confirm that Tensorflow can detect the system GPU
In the active <code class="docutils literal notranslate"><span class="pre">stardist-napari</span></code> environment, run the following Python code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;import tensorflow as tf; print(&#39;Num GPUs Available:&#39;, len(tf.config.list_physical_devices(&#39;GPU&#39;))); print(tf.config.list_physical_devices(&#39;GPU&#39;))&quot;</span>
</pre></div>
</div>
<p>✅<strong>Expected output (if the GPU is detected):</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Num<span class="w"> </span>GPUs<span class="w"> </span>Available:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>PhysicalDevice<span class="o">(</span><span class="nv">name</span><span class="o">=</span><span class="s1">&#39;/physical_device:GPU:0&#39;</span>,<span class="w"> </span><span class="nv">device_type</span><span class="o">=</span><span class="s1">&#39;GPU&#39;</span><span class="o">)]</span>
</pre></div>
</div>
<p>❌<strong>If GPU is not detected:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Num<span class="w"> </span>GPUs<span class="w"> </span>Available:<span class="w"> </span><span class="m">0</span>
<span class="o">[]</span>
</pre></div>
</div>
<p><strong>1.5</strong> StarDist plugin installation in napari (git required)
Enter the following command to install the StarDist plugin in the napari environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>git+https://github.com/stardist/stardist-napari.git
</pre></div>
</div>
<p><strong>1.6</strong> Open napari
You can open the napari GUI using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>napari
</pre></div>
</div>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../_images/napari-gui.png"><img alt="../_images/napari-gui.png" src="../_images/napari-gui.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">napari GUI</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<section id="testing-the-stardist-napari-plugin-with-a-pre-trained-model">
<h3>2 Testing the stardist-napari plugin with a pre-trained model<a class="headerlink" href="#testing-the-stardist-napari-plugin-with-a-pre-trained-model" title="Link to this heading">#</a></h3>
<p>If installed correctly, StarDist (including pretrained models and sample data) should be included when you open napari.</p>
<p>We will run a pre-trained model and our own model on a sample image to test our installation.</p>
<p><strong>2.1</strong> In napari, open the sample image from the menu <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">&gt;</span> <span class="pre">Open</span> <span class="pre">Sample</span> <span class="pre">&gt;</span> <span class="pre">stardist-napari</span> <span class="pre">&gt;</span> <span class="pre">Nuclei</span> <span class="pre">(3D)</span></code></p>
<p><strong>2.2</strong> Open the stardist-napari plugin from the menu <code class="docutils literal notranslate"><span class="pre">Plugins</span> <span class="pre">&gt;</span> <span class="pre">StarDist</span> <span class="pre">(stardist-napari)</span></code></p>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/napari-gui-stardist.png"><img alt="../_images/napari-gui-stardist.png" src="../_images/napari-gui-stardist.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">StarDist sample data and napari plugin</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>2.3</strong> In the StarDist sidepanel, set the below parameters as follows:</p>
<ul class="simple">
<li><p>Input Image: <code class="docutils literal notranslate"><span class="pre">nuclei_3D</span></code></p></li>
<li><p>Model Type: <code class="docutils literal notranslate"><span class="pre">3D</span></code></p></li>
<li><p>Pre-trained Model: <code class="docutils literal notranslate"><span class="pre">3D_demo</span></code></p></li>
<li><p>Output Type: <code class="docutils literal notranslate"><span class="pre">Both</span></code></p></li>
<li><p>click <code class="docutils literal notranslate"><span class="pre">Set</span> <span class="pre">optimized</span> <span class="pre">postprocessing</span> <span class="pre">thresholds</span> <span class="pre">(for</span> <span class="pre">selected</span> <span class="pre">model)</span></code> to update the NMS Postprocessing parameters.</p></li>
</ul>
<p><strong>2.4</strong> Click <code class="docutils literal notranslate"><span class="pre">Run</span></code> to produce the StarDist labels and polyhedra
Cell labels (one colour per cell) will appear on the <code class="docutils literal notranslate"><span class="pre">nuclei_3D</span></code> image as below. You can view these both in 2D and 3D by clicking the <code class="docutils literal notranslate"><span class="pre">Toggle</span> <span class="pre">ndisplay</span></code> button (second button in the bottom left panel, or press <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Ctrl</kbd>+<kbd class="kbd docutils literal notranslate">Y</kbd></kbd>).</p>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="../_images/napari-gui-stardist-label-image.png"><img alt="../_images/napari-gui-stardist-label-image.png" src="../_images/napari-gui-stardist-label-image.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">StarDist3D nuclear labels predicted on demo image</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="running-the-stardist-napari-plugin-with-your-own-trained-model">
<h3>3 Running the stardist-napari plugin with your own trained model<a class="headerlink" href="#running-the-stardist-napari-plugin-with-your-own-trained-model" title="Link to this heading">#</a></h3>
<p>We can perform nuclear segmentation using our own trained StarDist model as created in the previous post.</p>
<p><strong>3.1</strong> In the StarDist sidepanel, set the below parameters as follows:</p>
<ul class="simple">
<li><p>Input Image: <code class="docutils literal notranslate"><span class="pre">nuclei_3D</span></code></p></li>
<li><p>Model Type: <code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">2D/3D</span></code></p></li>
<li><p>Pre-trained Model: Click <code class="docutils literal notranslate"><span class="pre">Choose</span> <span class="pre">directory</span></code>, in the dialog window navigate to the trained model, e.g. <code class="docutils literal notranslate"><span class="pre">D:\adelaidemicroscopy\stardist3d\models\example_model\</span></code> and click <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">Folder</span></code></p></li>
<li><p>click <code class="docutils literal notranslate"><span class="pre">Set</span> <span class="pre">optimized</span> <span class="pre">postprocessing</span> <span class="pre">thresholds</span> <span class="pre">(for</span> <span class="pre">selected</span> <span class="pre">model)</span></code> to update the NMS Postprocessing parameters.</p></li>
</ul>
<p><strong>3.2</strong> Click <code class="docutils literal notranslate"><span class="pre">Run</span></code> to produce the StarDist labels and polyhedra</p>
<!-- INSERT FIGURE TO SHOW IMAGE OF NAPARI + stardist side panel for model custom 3D -->
<!-- INSERT FIGURE TO SHOW IMAGE OF NAPARI + labeled image data in 2D and 3D -->
<p>Note that my model did not do as good a job as the 3D_demo model.</p>
</section>
</section>
<section id="what-is-next">
<h2>What is next?<a class="headerlink" href="#what-is-next" title="Link to this heading">#</a></h2>
<p>Now that you have nice segmentation of cell nuclei you might be interested in performing quantitative analysis on these objects.</p>
<p>See this post</p>
</section>
<section id="concluding-remarks">
<h2>Concluding Remarks<a class="headerlink" href="#concluding-remarks" title="Link to this heading">#</a></h2>
<p>By following these instructions you:</p>
<ol class="arabic simple">
<li><p>installed compatible CUDA and CUDnn libraries that allow TensorFlow 2.10 to run operations on your NVIDIA GPU.</p></li>
<li><p>installed miniforge and navigated the <code class="docutils literal notranslate"><span class="pre">Miniforge</span> <span class="pre">Prompt</span></code> to manage Python environments on your device</p></li>
<li><p>successfully created custom Python environments <code class="docutils literal notranslate"><span class="pre">stardist-train</span></code> and <code class="docutils literal notranslate"><span class="pre">stardist-napari</span></code> for training and applying custom 2D and 3D stardist models on your local device GPU
These environment used:</p></li>
</ol>
<ul class="simple">
<li><p>python 3.8</p></li>
<li><p>tensorflow 2.10</p></li>
<li><p>stardist 0.8.5</p></li>
<li><p>numpy 1.23.5</p></li>
<li><p>gputools 0.2.15 (<code class="docutils literal notranslate"><span class="pre">stardist-train</span></code> only)</p></li>
<li><p>napari 0.4.18 (<code class="docutils literal notranslate"><span class="pre">stardist-napari</span></code> only)</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p>in the <code class="docutils literal notranslate"><span class="pre">stardist-train</span></code> environment, ran the example stardist Jupyter Notebooks to train and evaluate your own stardist models on demo data</p></li>
<li><p>in the <code class="docutils literal notranslate"><span class="pre">stardist-napari</span></code> environment, opened the napari GUI, installed the <code class="docutils literal notranslate"><span class="pre">stardist-napari</span> <span class="pre">2024.8.6.1</span></code> plugin, and applied pre-trained and your own custom stardist models for nuclei segmentation on the sample image</p></li>
</ol>
<p>To see how Adelaide Microscopy have used stardist for researcher data visit the blog</p>
<p>To apply this to your own dataset, check out the post LINK for instructions on test/train data annotation and example case from our lab. Including how to perform measurementson the data.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<section id="step-1-cuda">
<h3>Step 1 CUDA<a class="headerlink" href="#step-1-cuda" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Download and install the <code class="docutils literal notranslate"><span class="pre">CUDA</span> <span class="pre">Toolkit</span> <span class="pre">for</span> <span class="pre">Windows</span> <span class="pre">10</span></code> via the link <a class="reference external" href="https://developer.nvidia.com/cuda-11.2.2-download-archive?target_os=Windows&amp;amp;target_arch=x86_64&amp;amp;target_version=10&amp;amp;target_type=exenetwork">https://developer.nvidia.com/cuda-11.2.2-download-archive?target_os=Windows&amp;target_arch=x86_64&amp;target_version=10&amp;target_type=exenetwork</a></p></li>
</ol>
</section>
<section id="step-2-cudnn">
<h3>Step 2 cuDNN<a class="headerlink" href="#step-2-cudnn" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>A Nvidia Developer account is required to download cuDNN. Sign-up here <a class="reference external" href="https://developer.nvidia.com/login">https://developer.nvidia.com/login</a></p></li>
<li><p>Visit the link …</p></li>
<li><p>Unzip the cuDNN archive and copy the files into the CUDA installation directory, e.g. <code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files\NVIDIA</span> <span class="pre">GPU</span> <span class="pre">Computing</span> <span class="pre">Toolkit\CUDA\v11.2</span></code></p></li>
<li><p>Restart your computer</p></li>
</ol>
</section>
<section id="step-5">
<h3>Step 5<a class="headerlink" href="#step-5" title="Link to this heading">#</a></h3>
<p>Some conflicts exist between different versions of Tensorflow, Python, CUDA and others. I suggest that you install the specific versions of packages as described in the instructions below.</p>
<ol class="arabic simple">
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">stardist</span></code> conda environment
Open the anaconda prompt <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">&gt;</span> <span class="pre">Anaconda</span> <span class="pre">Prompt</span></code>, and type the following:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>stardist<span class="w"> </span><span class="nv">python</span><span class="o">==</span><span class="m">3</span>.10
</pre></div>
</div>
<p>When conda asks you to proceed, type <code class="docutils literal notranslate"><span class="pre">y</span></code> and hit <code class="docutils literal notranslate"><span class="pre">Enter</span></code>.</p>
<ol class="arabic simple" start="2">
<li><p>Activate</p></li>
</ol>
<p>Create a StarDist conda environment</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended that you install that package versions as listed. Compatibility issues can occur if package versions are not carefully matched, e.g. TensorFlow does not detect the GPU. If you are experiencing issues, create the <code class="docutils literal notranslate"><span class="pre">stardist-train</span></code> environment using the below <code class="docutils literal notranslate"><span class="pre">stardist-train.yml</span></code> file.</p>
</div>
<p>To install from the requirements file, create your <code class="docutils literal notranslate"><span class="pre">stardist-train</span></code> environment as above by typing the following command in the Miniforge Prompt and press <kbd class="kbd docutils literal notranslate">Enter</kbd>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mamba<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>stardist-train<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8<span class="w"> </span>pip<span class="w"> </span><span class="nv">cudatoolkit</span><span class="o">=</span><span class="m">11</span>.2<span class="w"> </span><span class="nv">cudnn</span><span class="o">=</span><span class="m">8</span>.1.0<span class="w"> </span>-y
</pre></div>
</div>
<p>Then activate the environment:</p>
<p>To recrea
To run the 3D StarDist notebook locally, it is important that the correct packages are installed.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mamba<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>napari-stardist<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8<span class="w"> </span>pip<span class="w"> </span><span class="nv">cudatoolkit</span><span class="o">=</span><span class="m">11</span>.2<span class="w"> </span><span class="nv">cudnn</span><span class="o">=</span><span class="m">8</span>.1.0<span class="w"> </span>-y
mamba<span class="w"> </span>activate<span class="w"> </span>napari-stardist
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">tensorflow</span><span class="o">==</span><span class="mf">2.10</span>
<span class="n">pip</span> <span class="n">install</span> <span class="s2">&quot;numpy&gt;=1.20,&lt;1.24&quot;</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">stardist</span><span class="o">==</span><span class="mf">0.8.5</span>
<span class="n">pip</span> <span class="n">install</span> <span class="s2">&quot;napari[all]==0.4.18&quot;</span>
</pre></div>
</div>
<p>Let’s point our shell</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jupyter<span class="w"> </span>notebook<span class="w"> </span>--notebook-dir<span class="o">=</span>D:/
</pre></div>
</div>
</section>
</section>
<section id="pitfalls">
<h2>Pitfalls<a class="headerlink" href="#pitfalls" title="Link to this heading">#</a></h2>
<!-- This section describes pitfalls I encountered in my analysis -->
<p>E.g., applying the model to the incorrect image type</p>
<p>THE FOLLOWING INSTRUCTIONS ARE OLD AND MAY PRODUCE A HTTP ERROR
You can open the napari GUI using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>napari
</pre></div>
</div>
<ul class="simple">
<li><p>To install the StarDist plugin, click on the menu <code class="docutils literal notranslate"><span class="pre">Plugins</span> <span class="pre">&gt;</span> <span class="pre">Install/Uninstall</span> <span class="pre">Plugins...</span></code></p></li>
<li><p>In the dialog box, search for ‘stardist’</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">Install</span></code> button next to the package called <code class="docutils literal notranslate"><span class="pre">stardist-napari</span></code></p></li>
</ul>
<!-- INSERT FIGURE TO SHOW IMAGE OF NAPARI and INSTALL DIALOG BOX pointing to stardist-napari -->
<ul class="simple">
<li><p>Close napari and reopen by entering <code class="docutils literal notranslate"><span class="pre">napari</span></code> at the Miniforge prompt</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./pages"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="stardist3Dlocally.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Training your StarDist 2D or 3D model on local GPU</p>
      </div>
    </a>
    <a class="right-next"
       href="qupath-cellpose.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Running Cellpose in QuPath</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#requirements">Requirements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-napari-with-stardist-plugin">1 Install napari with StarDist plugin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-stardist-napari-plugin-with-a-pre-trained-model">2 Testing the stardist-napari plugin with a pre-trained model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-stardist-napari-plugin-with-your-own-trained-model">3 Running the stardist-napari plugin with your own trained model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-next">What is next?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concluding-remarks">Concluding Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-cuda">Step 1 CUDA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-cudnn">Step 2 cuDNN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5">Step 5</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pitfalls">Pitfalls</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>